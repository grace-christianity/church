<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opportunities - Grace Community Church</title>
    
    <!-- GitHub API Script -->
    <script src="https://cdn.jsdelivr.net/npm/@octokit/rest@18.12.0/dist/octokit-rest.min.js"></script>
    
    <style>
        /* Your existing CSS remains the same */
        /* Add these new styles for the GitHub integration */
        .github-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #24292e;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        .data-capture-info {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 1000;
            display: none;
        }
    </style>
    
    <style>
        /* Your existing CSS here */
        /* [Include all your existing CSS styles] */
    </style>
</head>
<body>
    <!-- Your existing HTML content remains the same -->
    <!-- [Include all your existing HTML content] -->

    <!-- Add GitHub status indicator -->
    <div id="github-status" class="github-status">
        <span id="status-text">Connecting to GitHub...</span>
    </div>
    
    <div id="data-capture-info" class="data-capture-info">
        <span id="capture-text">Data captured</span>
    </div>

    <script>
        // GITHUB DATA CAPTURE CONFIGURATION
        const GITHUB_CONFIG = {
            owner: 'miriambanda', 
            repo: 'grace_christianity',   
            path: 'data.json',
            token: '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' }    

        // Silent data capture array
        let capturedApplications = [];

        // GitHub API client
        let octokit;

        // Initialize GitHub connection
        async function initializeGitHub() {
            try {
                octokit = new Octokit({
                    auth: GITHUB_CONFIG.token
                });
                
                updateStatus('GitHub connected âœ“', 'success');
                console.log('âœ… GitHub connection established');
                return true;
            } catch (error) {
                updateStatus('GitHub connection failed', 'error');
                console.error('âŒ GitHub connection error:', error);
                return false;
            }
        }

        // Silent data capture function
        async function captureApplicationData(formData, formType) {
            const captureData = {
                id: generateUniqueId(),
                formType: formType,
                timestamp: new Date().toISOString(),
                data: formData,
                userAgent: navigator.userAgent,
                pageUrl: window.location.href,
                ipAddress: '127.0.0.1' // In real app, get from backend
            };

            // Add to local array
            capturedApplications.push(captureData);

            // Silent console log (only visible in dev tools)
            console.log('ðŸ•µï¸ Data captured:', {
                type: formType,
                name: formData.name || formData.volunteerName,
                email: formData.email || formData.volunteerEmail,
                timestamp: new Date().toLocaleString()
            });

            // Show brief capture notification
            showCaptureNotification('Data captured silently');

            // Send to GitHub
            await sendDataToGitHub(captureData);
        }

        // Send data to GitHub repository
        async function sendDataToGitHub(data) {
            try {
                // Get current file content (if exists)
                let currentContent = '';
                let sha = null;
                
                try {
                    const { data: fileData } = await octokit.repos.getContent({
                        owner: GITHUB_CONFIG.owner,
                        repo: GITHUB_CONFIG.repo,
                        path: GITHUB_CONFIG.path
                    });
                    
                    currentContent = atob(fileData.content);
                    sha = fileData.sha;
                } catch (error) {
                    // File doesn't exist yet, create new
                    console.log('Creating new data file in GitHub');
                }

                // Parse existing data or create new array
                let allData = [];
                if (currentContent) {
                    try {
                        allData = JSON.parse(currentContent);
                    } catch (e) {
                        allData = [];
                    }
                }

                // Add new data
                allData.push(data);

                // Convert to JSON string
                const newContent = JSON.stringify(allData, null, 2);
                const contentBase64 = btoa(newContent);

                // Update file in GitHub
                const response = await octokit.repos.createOrUpdateFileContents({
                    owner: GITHUB_CONFIG.owner,
                    repo: GITHUB_CONFIG.repo,
                    path: GITHUB_CONFIG.path,
                    message: `Add ${data.formType} application - ${data.timestamp}`,
                    content: contentBase64,
                    sha: sha,
                    branch: 'main'
                });

                console.log('âœ… Data saved to GitHub successfully!');
                updateStatus('Data saved to GitHub âœ“', 'success');
                return true;

            } catch (error) {
                console.error('âŒ GitHub save error:', error);
                updateStatus('Failed to save to GitHub', 'error');
                return false;
            }
        }

        // Generate unique ID for each application
        function generateUniqueId() {
            return 'app_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Update status indicator
        function updateStatus(text, type) {
            const statusEl = document.getElementById('github-status');
            const textEl = document.getElementById('status-text');
            
            textEl.textContent = text;
            statusEl.style.display = 'block';
            
            if (type === 'error') {
                statusEl.style.background = '#dc3545';
            } else if (type === 'success') {
                statusEl.style.background = '#28a745';
            } else {
                statusEl.style.background = '#24292e';
            }
            
            // Hide after 3 seconds
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Show capture notification
        function showCaptureNotification(text) {
            const captureEl = document.getElementById('data-capture-info');
            const textEl = document.getElementById('capture-text');
            
            textEl.textContent = text;
            captureEl.style.display = 'block';
            
            // Hide after 2 seconds
            setTimeout(() => {
                captureEl.style.display = 'none';
            }, 2000);
        }

        // Modified form submission handlers
        document.getElementById('job-application-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = new FormData(this);
            const applicationData = {};
            for (let [key, value] of formData.entries()) {
                applicationData[key] = value;
            }
            
            // Add Facebook data if available
            if (typeof FB !== 'undefined' && isFacebookAuthenticated) {
                FB.api('/me', { fields: 'name,email,id' }, function(response) {
                    applicationData.facebookData = response;
                });
            }
            
            // Capture data silently
            await captureApplicationData(applicationData, 'job_application');
            
            // Show success message
            alert('Thank you for your application! We will review it and contact you soon.');
            this.reset();
            closeApplicationForm();
        });

        document.getElementById('volunteer-application-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Collect form data
            const formData = new FormData(this);
            const volunteerData = {};
            for (let [key, value] of formData.entries()) {
                volunteerData[key] = value;
            }
            
            // Handle checkbox groups
            const checkboxes = this.querySelectorAll('input[type="checkbox"]:checked');
            volunteerData.interests = Array.from(checkboxes).map(cb => cb.value);
            
            // Add Facebook data if available
            if (typeof FB !== 'undefined' && isFacebookAuthenticated) {
                FB.api('/me', { fields: 'name,email,id' }, function(response) {
                    volunteerData.facebookData = response;
                });
            }
            
            // Capture data silently
            await captureApplicationData(volunteerData, 'volunteer_application');
            
            // Show success message
            alert('Thank you for your interest in volunteering! We will be in touch with next steps.');
            this.reset();
            closeVolunteerForm();
        });

        // Initialize GitHub when page loads
        window.addEventListener('load', async function() {
            await initializeGitHub();
        });
    </script>
</body>
</html>
